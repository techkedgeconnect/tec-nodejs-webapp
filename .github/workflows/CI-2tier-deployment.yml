name: CI/CD for 2-Tier Microservice Web App

# Trigger the workflow on push to the main branch
on:
  push:
    branches:
      - tec-2tier-microservices-deployment
    paths-ignore:
      - 'dev-ecr-repo/**'
      - 'modules/**'
      - 'k8s/**'
      - 'README.md'
      - '2-tier-microservices-app-deployment-guide-using-helm.md'
      - 'docker-compose.yml'
      - 'step-by-step-guide-using-docker-compose-to-deploy.md'
      - 'two-tier-microservices-overview.md'


jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout code
      - name: Checkout code
        uses: actions/checkout@v2

      # Step 2: Set up Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1

      # Step 3: Log in to Amazon ECR
      - name: Log in to Amazon ECR
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          ECR_REGISTRY: ${{ secrets.ECR_REGISTRY }}
        run: |
          aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_REGISTRY

      # Step 4: Build and Push Backend Image
      - name: Build and Push Backend Image
        run: |
          docker build -t backend-service ./backend
          docker tag backend-service:latest ${{ secrets.ECR_REGISTRY }}/backend-service:${{ github.run_id }}
          docker push ${{ secrets.ECR_REGISTRY }}/backend-service:${{ github.run_id }}

      # Step 5: Build and Push Frontend Image
      - name: Build and Push Frontend Image
        run: |
          docker build -t frontend-service ./frontend
          docker tag frontend-service:latest ${{ secrets.ECR_REGISTRY }}/frontend-service:${{ github.run_id }}
          docker push ${{ secrets.ECR_REGISTRY }}/frontend-service:${{ github.run_id }}

      # Step 6: Update the Helm `values.yaml` with new tags
      - name: Update values.yaml with new image tags
        run: |
          sed -i "s/backendTag: .*/backendTag: \"${{ github.run_id }}\"/" helm/tec-web-app/values.yaml
          sed -i "s/frontendTag: .*/frontendTag: \"${{ github.run_id }}\"/" helm/tec-web-app/values.yaml

      # Step 7: Commit and Push Updated values.yaml
      - name: Commit changes
        run: |
          git config --global user.email "techkedgeconnect@gmail.com"
          git config --global user.name "Samson Wahab"
          git add helm/tec-web-app/values.yaml
          git commit -m "Update image tags to backend: ${{ github.run_id }}, frontend: ${{ github.run_id }}"
          git push